<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FixPoint - User Profile</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Custom CSS -->
    <style>
        .profile-header {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .profile-picture {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .profile-tabs .nav-link {
            color: #495057;
            border: none;
            padding: 15px 20px;
        }
        .profile-tabs .nav-link.active {
            color: #0066cc;
            background-color: transparent;
            border-bottom: 2px solid #0066cc;
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
        }
        .form-container {
            background-color: #fff;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .bg-gradient-primary {
            background: linear-gradient(to right, #0066cc, #17a2b8);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-gradient-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-tools me-2"></i>FixPoint
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="user_dashboard.html">
                            <i class="fas fa-tachometer-alt me-1"></i> Dashboard
                        </a>
                    </li>
                    <!-- <li class="nav-item">
                        <a class="nav-link" href="browse_services.html">
                            <i class="fas fa-search me-1"></i> Browse Services
                        </a>
                    </li> -->
                    <li class="nav-item">
                        <a class="nav-link" href="request_service.html">
                            <i class="fas fa-plus-circle me-1"></i> Request Service
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="my_requests.html">
                            <i class="fas fa-clipboard-list me-1"></i> My Requests
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-bell me-1"></i>
                            <span class="badge bg-danger notification-badge">3</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#">New notification</a></li>
                            <li><a class="dropdown-item" href="#">New notification</a></li>
                            <li><a class="dropdown-item" href="#">New notification</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">See all notifications</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i> User Name
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item active" href="user_profile.html"><i class="fas fa-id-card me-2"></i>My Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <img src="https://source.unsplash.com/random/150x150/?person" alt="Profile Picture" class="profile-picture mb-3">
                    <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
                    <button class="btn btn-outline-primary btn-sm" id="changePhotoBtn">
                        <i class="fas fa-camera me-1"></i> Change Photo
                    </button>
                </div>
                <div class="col-md-9">
                    <div class="d-md-flex justify-content-between align-items-end">
                        <div>
                            <h2 class="mb-1">User Name</h2>
                            <p class="text-muted mb-2"><i class="fas fa-calendar-alt me-1"></i> Member since [Date]</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Tabs -->
        <ul class="nav nav-tabs mb-4 profile-tabs" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal" type="button" role="tab" aria-controls="personal" aria-selected="true">
                    <i class="fas fa-user me-1"></i> Personal Info
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab" aria-controls="security" aria-selected="false">
                    <i class="fas fa-shield-alt me-1"></i> Security
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="profileTabsContent">
            <!-- Personal Info Tab -->
            <div class="tab-pane fade show active" id="personal" role="tabpanel" aria-labelledby="personal-tab">
                <div class="form-container">
                    <h4 class="mb-4">Personal Information</h4>
                    <form>
                        <div class="mb-4">
                            <label for="firstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="firstName" placeholder="Enter first name">
                        </div>
                        <div class="mb-4">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="email" placeholder="Enter email address">
                        </div>
                        <div class="mb-4">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phone" placeholder="Enter phone number">
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Security Tab -->
            <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="security-tab">
                <div class="form-container">
                    <h4 class="mb-4">Security Settings</h4>
                    <div id="security-alerts"></div>
                    <form id="password-change-form">
                        <div class="mb-4">
                            <h5>Password Management</h5>
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">Current Password</label>
                                <input type="password" class="form-control" id="currentPassword">
                                <div class="invalid-feedback" id="currentPassword-feedback"></div>
                            </div>
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">New Password</label>
                                <input type="password" class="form-control" id="newPassword">
                                <div class="form-text">Password must be at least 8 characters with letters, numbers, and special characters.</div>
                                <div class="invalid-feedback" id="newPassword-feedback"></div>
                            </div>
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                <input type="password" class="form-control" id="confirmPassword">
                                <div class="invalid-feedback" id="confirmPassword-feedback"></div>
                            </div>
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-primary" id="updatePasswordBtn">Update Password</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-3">
                    <h5><i class="fas fa-tools me-2"></i>FixPoint</h5>
                    <p class="text-white-50">Your trusted platform for local home services.</p>
                </div>
                <div class="col-md-3">
                    <h6>Quick Links</h6>
                    <ul class="list-unstyled">
                        <li><a href="#" class="text-decoration-none text-white-50 hover-white">About Us</a></li>
                        <li><a href="#" class="text-decoration-none text-white-50 hover-white">Our Services</a></li>
                        <li><a href="#" class="text-decoration-none text-white-50 hover-white">Become a Provider</a></li>
                        <li><a href="#" class="text-decoration-none text-white-50 hover-white">Contact Us</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h6>Contact Info</h6>
                    <ul class="list-unstyled text-white-50">
                        <li><i class="fas fa-map-marker-alt me-2"></i>123 Service St, City, Country</li>
                        <li><i class="fas fa-phone me-2"></i>(123) 456-7890</li>
                        <li><i class="fas fa-envelope me-2"></i>info@fixpoint.com</li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h6>Follow Us</h6>
                    <div class="d-flex">
                        <a href="#" class="text-decoration-none text-white me-2"><i class="fab fa-facebook-square fa-2x"></i></a>
                        <a href="#" class="text-decoration-none text-white me-2"><i class="fab fa-twitter-square fa-2x"></i></a>
                        <a href="#" class="text-decoration-none text-white me-2"><i class="fab fa-instagram fa-2x"></i></a>
                        <a href="#" class="text-decoration-none text-white"><i class="fab fa-linkedin fa-2x"></i></a>
                    </div>
                    <div class="mt-3">
                        <form>
                            <div class="input-group">
                                <input type="email" class="form-control" placeholder="Subscribe to newsletter">
                                <button class="btn btn-primary" type="submit">Go</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <hr class="my-4 bg-light">
            <div class="text-center text-white-50">
                <small>&copy; 2023 FixPoint. All Rights Reserved.</small>
            </div>
        </div>
    </footer>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Profile Management JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get form elements
            const personalInfoForm = document.querySelector('#personal form');
            const passwordChangeForm = document.getElementById('password-change-form');
            const firstNameInput = document.getElementById('firstName');
            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('phone');
            const profileNameElement = document.querySelector('.profile-header h2');
            
            // Profile photo elements
            const changePhotoBtn = document.getElementById('changePhotoBtn');
            const profilePicInput = document.getElementById('profilePicInput');
            const profilePicture = document.querySelector('.profile-picture');
            
            // Security tab elements
            const currentPasswordInput = document.getElementById('currentPassword');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const securityAlertsContainer = document.getElementById('security-alerts');
            
            // Set up profile photo change functionality
            if (changePhotoBtn && profilePicInput) {
                changePhotoBtn.addEventListener('click', function() {
                    profilePicInput.click();
                });
                
                profilePicInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        uploadProfilePhoto(e.target.files[0]);
                    }
                });
            }
            
            // Function to upload profile photo
            function uploadProfilePhoto(file) {
                // Check file type
                if (!file.type.match('image.*')) {
                    showAlert('personal', 'danger', 'Please select an image file');
                    return;
                }
                
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showAlert('personal', 'danger', 'Image size should be less than 5MB');
                    return;
                }
                
                // Show loading state on button
                changePhotoBtn.disabled = true;
                const originalBtnText = changePhotoBtn.innerHTML;
                changePhotoBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
                
                const formData = new FormData();
                formData.append('profilePic', file);
                
                fetch('/update-profile-pic', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to upload image');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Show success message
                        showAlert('personal', 'success', 'Profile photo updated successfully');
                        
                        // Update the profile picture on the page
                        if (data.photoUrl) {
                            profilePicture.src = data.photoUrl;
                        } else {
                            // Create a local preview if server doesn't return URL
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                profilePicture.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    } else {
                        showAlert('personal', 'danger', data.message || 'Failed to update profile photo');
                    }
                })
                .catch(error => {
                    console.error('Error uploading profile photo:', error);
                    showAlert('personal', 'danger', 'Error uploading photo. Please try again later.');
                })
                .finally(() => {
                    // Reset button state
                    changePhotoBtn.disabled = false;
                    changePhotoBtn.innerHTML = originalBtnText;
                    // Reset file input
                    profilePicInput.value = '';
                });
            }
            
            // Fetch profile data when page loads
            fetchProfileData();
            
            // Handle form submissions
            if (personalInfoForm) {
                personalInfoForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    updateProfile();
                });
            }
            
            if (passwordChangeForm) {
                passwordChangeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    updatePassword();
                });
            }
            
            // Function to fetch user profile data
            function fetchProfileData() {
                fetch('/api/user/profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch profile data');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        populateProfileData(data.data);
                    }
                })
                .catch(error => {
                    console.error('Error fetching profile data:', error);
                    showAlert('personal', 'danger', 'Failed to load profile data');
                });
            }
            
            // Function to populate profile data
            function populateProfileData(userData) {
                if (firstNameInput) firstNameInput.value = userData.name || '';
                if (emailInput) emailInput.value = userData.email || '';
                if (phoneInput) phoneInput.value = userData.contact || '';
                
                // Update header name
                if (userData.name && profileNameElement) {
                    profileNameElement.textContent = userData.name;
                    
                    // Update navbar user name
                    const userDropdown = document.getElementById('userDropdown');
                    if (userDropdown) {
                        userDropdown.innerHTML = `<i class="fas fa-user-circle me-1"></i> ${userData.name}`;
                    }
                }

                // Update profile picture if available
                const profilePic = document.querySelector('.profile-picture');
                if (profilePic && userData.profile_pic && !userData.profile_pic.includes('default.jpg')) {
                    profilePic.src = userData.profile_pic;
                }
                
                // Update member since date
                const memberSinceElement = document.querySelector('.profile-header p:nth-child(2)');
                if (memberSinceElement && userData.createdAt) {
                    const joinDate = new Date(userData.createdAt).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long'
                    });
                    memberSinceElement.innerHTML = `<i class="fas fa-calendar-alt me-1"></i> Member since ${joinDate}`;
                }
            }
            
            // Function to update user profile
            function updateProfile() {
                // Show processing state
                const submitBtn = personalInfoForm.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

                const updatedProfile = {
                    name: firstNameInput.value.trim(),
                    contact: phoneInput.value.trim()
                };
                
                // Validate input
                let isValid = true;
                if (!updatedProfile.name) {
                    showInvalidFeedback(firstNameInput, 'Name is required');
                    isValid = false;
                }
                
                if (!updatedProfile.contact) {
                    showInvalidFeedback(phoneInput, 'Phone number is required');
                    isValid = false;
                }
                
                if (!isValid) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    return;
                }
                
                // Send update request
                fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(updatedProfile)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update profile');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showAlert('personal', 'success', 'Profile updated successfully');
                        
                        // Update profile name in header
                        if (profileNameElement && updatedProfile.name) {
                            profileNameElement.textContent = updatedProfile.name;
                            
                            // Update navbar user name
                            const userDropdown = document.getElementById('userDropdown');
                            if (userDropdown) {
                                userDropdown.innerHTML = `<i class="fas fa-user-circle me-1"></i> ${updatedProfile.name}`;
                            }
                        }
                    } else {
                        showAlert('personal', 'danger', data.message || 'Failed to update profile');
                    }
                })
                .catch(error => {
                    console.error('Error updating profile:', error);
                    showAlert('personal', 'danger', 'Error updating profile. Please try again later.');
                })
                .finally(() => {
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                });
            }
            
            // Function to update password
            function updatePassword() {
                // Show processing state
                const submitBtn = document.getElementById('updatePasswordBtn');
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Updating...';
                
                // Get password values
                const currentPassword = currentPasswordInput.value;
                const newPassword = newPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                
                // Reset previous validation states
                resetValidationState(currentPasswordInput);
                resetValidationState(newPasswordInput);
                resetValidationState(confirmPasswordInput);
                
                // Validate input
                let isValid = true;
                
                if (!currentPassword) {
                    showInvalidFeedback(currentPasswordInput, 'Current password is required');
                    isValid = false;
                }
                
                if (!newPassword) {
                    showInvalidFeedback(newPasswordInput, 'New password is required');
                    isValid = false;
                } else if (newPassword.length < 8) {
                    showInvalidFeedback(newPasswordInput, 'Password must be at least 8 characters long');
                    isValid = false;
                } else if (!/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?])/.test(newPassword)) {
                    showInvalidFeedback(newPasswordInput, 'Password must contain uppercase, lowercase, number and special character');
                    isValid = false;
                }
                
                if (!confirmPassword) {
                    showInvalidFeedback(confirmPasswordInput, 'Please confirm your new password');
                    isValid = false;
                } else if (confirmPassword !== newPassword) {
                    showInvalidFeedback(confirmPasswordInput, 'Passwords do not match');
                    isValid = false;
                }
                
                if (!isValid) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    return;
                }
                
                // Send password update request
                fetch('/api/user/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        currentPassword,
                        newPassword
                    })
                })
                .then(response => {
                    if (!response.ok && response.status === 401) {
                        showInvalidFeedback(currentPasswordInput, 'Incorrect current password');
                        throw new Error('Incorrect current password');
                    }
                    if (!response.ok) {
                        throw new Error('Failed to update password');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Clear password fields
                        currentPasswordInput.value = '';
                        newPasswordInput.value = '';
                        confirmPasswordInput.value = '';
                        
                        // Show success message
                        showAlert('security', 'success', 'Password updated successfully');
                    } else {
                        if (data.message && data.message.includes('incorrect')) {
                            showInvalidFeedback(currentPasswordInput, 'Incorrect current password');
                        } else {
                            showAlert('security', 'danger', data.message || 'Failed to update password');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error updating password:', error);
                    if (!error.message.includes('Incorrect current password')) {
                        showAlert('security', 'danger', 'Error updating password. Please try again later.');
                    }
                })
                .finally(() => {
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                });
            }
            
            // Helper function to show invalid feedback
            function showInvalidFeedback(inputElement, message) {
                inputElement.classList.add('is-invalid');
                const feedbackElement = document.getElementById(`${inputElement.id}-feedback`);
                if (feedbackElement) {
                    feedbackElement.textContent = message;
                }
            }
            
            // Helper function to reset validation state
            function resetValidationState(inputElement) {
                inputElement.classList.remove('is-invalid');
                const feedbackElement = document.getElementById(`${inputElement.id}-feedback`);
                if (feedbackElement) {
                    feedbackElement.textContent = '';
                }
            }
            
            // Helper function to show alert
            function showAlert(tabId, type, message) {
                let alertContainer;
                if (tabId === 'security') {
                    alertContainer = securityAlertsContainer;
                } else {
                    alertContainer = document.createElement('div');
                    document.querySelector(`#${tabId} .form-container`).prepend(alertContainer);
                }
                
                alertContainer.innerHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                
                // Auto dismiss after 5 seconds
                setTimeout(() => {
                    const alert = alertContainer.querySelector('.alert');
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
            
            // Add input event listeners to reset validation state
            [currentPasswordInput, newPasswordInput, confirmPasswordInput].forEach(input => {
                if (input) {
                    input.addEventListener('input', () => resetValidationState(input));
                }
            });
        });
    </script>
</body>
</html>
``` 
